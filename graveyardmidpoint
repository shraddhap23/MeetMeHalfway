$(document).ready(function() {
  var directionsDisplay = new google.maps.DirectionsRenderer;
  var directionsService = new google.maps.DirectionsService;
  var map; 
  var infowindow = new google.maps.InfoWindow(); 
  var marker;

  //AUTOCOMPLETE ADDRESS FOR FORM & RENDERS MAP ON INITIAL LOAD
  google.maps.event.addDomListener(window, 'load', initialize);
  google.maps.event.addDomListener(window, 'load', initMap);


// MIDWAY POINT
// google.maps.geometry.spherical.interpolate(xPlace, yPlace, 0.5);

  //AUTOCOMPLETE ADDRESS
  function initialize() {
    var input = document.getElementById('start');
    var autocomplete = new google.maps.places.Autocomplete(input);

    var input2 = document.getElementById('endloc');
    var autocomplete2 = new google.maps.places.Autocomplete(input2);
  } 

  //GIVES LAT AND LONG OF GIVEN ADDRESSES FROM AUTOCOMPLETE 
  function searchAddress() {
    var start = document.getElementById('start').value;
    var endloc = document.getElementById('endloc').value;
    var geocoder = new google.maps.Geocoder();
    // var sLatLngCoords = [];
    // var eLatLngCoords = [];
    var sLatLngCoords = {};
    var eLatLngCoords = {};


    geocoder.geocode({address: start}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
      var mySResultLat = results[0].geometry.location.lat(); 
      var mySResultLng = results[0].geometry.location.lng(); 

      // sLatLngCoords.push(mySResultLat, mySResultLng) //combines start location lat and long
      //   console.log(sLatLngCoords)

      sLatLngCoords.lat = mySResultLat;
      sLatLngCoords.lng = mySResultLng;
      }
    });

    geocoder.geocode({address: endloc}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
      var myEResultLat = results[0].geometry.location.lat();
      var myEResultLng = results[0].geometry.location.lng();

      // eLatLngCoords.push(myEResultLat, myEResultLng) //combines end location lat and long
      //   console.log(eLatLngCoords)

      eLatLngCoords.lat = myEResultLat;
      eLatLngCoords.lng = myEResultLng;
    }
    });

    var midpoint = google.maps.geometry.spherical.interpolate(sLatLngCoords, eLatLngCoords, 0.5);
    
      // console.log("lol");
      // console.log(eLatLngCoords);
      // console.log(sLatLngCoords);
      // console.log(midpoint);  
    
    // infowindow.position = midpoint;

    var marker = new google.maps.Marker({
      position: midpoint,
      map: map
    });
    google.maps.event.addListener(marker, 'click', function() {
      infowindow.open(map, marker);
    });
    return marker;
  }


  function createMarker(latlng, label, html) {
    var contentString = '<b>' + label + '</b><br>' + html;
    var marker = new google.maps.Marker({
      position: latlng, 
      map: map,
      title: label,
      zIndex: Math.round(latlng.lat()*-100000)<<5
      });
      marker.myname = label;

    google.maps.event.addListener(marker, 'click', function() {
      infowindow.setContent(contentString + '<br>' + marker.getPosition().toUrlValue(6));
      infowindow.open(map, marker);
    });
    return marker;
  }

  //SHOWS INFOWINDOW 
  function bindInfoWindow(marker, map, infowindow, content) {
  marker.addListener('click', function(){
    infowindow.setContent(content);  
    infowindow.open(map, this);           
  }); 
  } 

  //SHOWS INITIAL MAP (no directions)
  function initMap() {
    var myCLatLng = new google.maps.LatLng(40.712950, -73.957758);
    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: 16,
      center: myCLatLng
    });
    directionsDisplay.setMap(map);

    var request = {
      location: myCLatLng,
      radius: '500',
      types: ['restaurant']
    };

    var service = new google.maps.places.PlacesService(map);
    service.nearbySearch(request, function(results, status) {
      if (status == google.maps.places.PlacesServiceStatus.OK) {
        for (var i = 0; i < results.length; i++) {
          var place = results[i];
          var marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location
          });
 
          var content = '<strong>' + place.name + '</strong><br>' 
            + '$$$ = ' + place.price_level + '<br>' 
            // + 'Place ID: ' + place.place_id + '<br>' // Test tag, unnecessary for users
            + 'Address: ' + place.vicinity + '<br>'  //using "place.formatted_address" would come up as undefined
            // + 'Ph: ' + place.formatted_phone_number + '<br>' //also undefined 
            + 'Rating: ' + place.rating + ' out of 5 stars' + '<br>'  
            + 'Coordinates: ' + place.geometry.location + '<br>'
            + 'Is it open now? ' + place.opening_hours.open_now + '<br>'
        
          bindInfoWindow(marker, map, infowindow, content) 
        }
      }
    });

  //MODE OF TRANSPORT REFLECTED ON CHANGE INSTEAD OF HAVING TO PRESS REFRESH
    calculateAndDisplayRoute(directionsService, directionsDisplay);
    document.getElementById('mode').addEventListener('change', function() {
      calculateAndDisplayRoute(directionsService, directionsDisplay);
    });
  }

  //TAKES START AND END LOCATIONS AND RENDERS DIRECTION ON MAP
  function calculateAndDisplayRoute(directionsService, directionsDisplay) {
    var input = document.getElementById('start').value

    var input2 = document.getElementById('endloc').value

    var selectedMode = document.getElementById('mode').value;
    directionsService.route({
      origin: input,
      destination: input2, 
      travelMode: google.maps.TravelMode[selectedMode] //travel mode from drop down
    }, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
      } else {
        window.alert('Directions request failed due to ' + status);
      }
    });
  }

  $('#submit_button').click(function(){
    calculateAndDisplayRoute(directionsService, directionsDisplay);
    searchAddress()
    });
});